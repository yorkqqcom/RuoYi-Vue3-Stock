# Tushare下载任务：单个接口 vs 流程配置差异分析

## 一、核心差异对比

### 1. 任务类型识别
- **单个接口任务**：`task.workflow_id` 为 `None`，使用 `task.config_id` 获取接口配置
- **流程配置任务**：`task.workflow_id` 不为 `None`，使用 `task.workflow_id` 获取流程配置，流程中包含多个步骤

### 2. 执行方式差异

#### 单个接口任务 (`execute_single_api`)
- **执行单元**：单个接口调用
- **参数来源**：
  1. 接口默认参数 (`config.api_params`)
  2. 任务参数覆盖 (`task.task_params`)
- **数据流**：直接调用 → 获取数据 → 保存
- **日志记录**：1条日志记录
- **错误处理**：失败则整个任务失败

#### 流程配置任务 (`execute_workflow`)
- **执行单元**：多个步骤按顺序执行
- **参数来源**：
  1. 接口默认参数 (`config.api_params`)
  2. 步骤参数 (`step.step_params`，支持从前一步获取数据)
  3. 任务参数覆盖 (`task.task_params`)
- **数据流**：步骤1 → 数据传递 → 步骤2 → 数据传递 → ...
- **日志记录**：每个步骤1条日志（格式：`{task_name}[{step_name}]`）
- **错误处理**：单个步骤失败可继续执行后续步骤
- **特殊功能**：
  - 支持步骤间数据传递 (`previous_results`)
  - 支持条件执行 (`condition_expr`)
  - 支持从前一步结果中获取参数值（`${previous_step.field}` 格式）

### 3. 配置项差异

| 配置项 | 单个接口任务 | 流程配置任务 |
|--------|------------|------------|
| `config_id` | ✅ 必需 | ❌ 不需要（在步骤中配置） |
| `workflow_id` | ❌ 不需要 | ✅ 必需 |
| `task_params` | ✅ 覆盖接口参数 | ✅ 覆盖所有步骤参数 |
| `save_path` | ✅ 单个文件路径 | ✅ 多个文件路径（每个步骤一个） |
| `data_table_name` | ✅ 单个表名 | ✅ 可配置每个步骤的表名 |
| `save_to_db` | ✅ 统一配置 | ✅ 统一配置（所有步骤） |

### 4. 日志记录差异

#### 单个接口任务日志
- **日志数量**：1条
- **任务名称**：`task.task_name`
- **记录数**：单次接口调用的记录数
- **文件路径**：单个文件路径

#### 流程配置任务日志
- **日志数量**：N条（N = 步骤数量）
- **任务名称**：`{task.task_name}[{step.step_name}]`
- **记录数**：每个步骤的记录数
- **文件路径**：每个步骤一个文件路径（文件名包含步骤顺序）

### 5. 数据存储差异

#### 单个接口任务
- **表名**：`task.data_table_name` 或默认 `tushare_{api_code}`
- **数据来源**：单次接口调用
- **数据量**：单次调用的数据量

#### 流程配置任务
- **表名**：`task.data_table_name` 或默认 `tushare_{api_code}`（所有步骤可共用或分别存储）
- **数据来源**：多个步骤的数据
- **数据量**：所有步骤的数据总和
- **数据关联**：通过 `task_id` 关联，可通过 `config_id` 区分不同步骤

### 6. 调度管理差异

#### 单个接口任务调度
- **执行时间**：根据 `cron_expression` 执行
- **执行频率**：单次执行
- **监控指标**：
  - 执行次数
  - 成功/失败次数
  - 最后执行时间
  - 数据记录数

#### 流程配置任务调度
- **执行时间**：根据 `cron_expression` 执行
- **执行频率**：单次执行（但包含多个步骤）
- **监控指标**：
  - 执行次数
  - 成功/失败次数（整体）
  - 步骤成功/失败次数（详细）
  - 最后执行时间
  - 总数据记录数
  - 各步骤数据记录数
  - 步骤执行时长

## 二、细化改进方案

### 1. 任务配置细化

#### 1.1 添加任务类型字段
- 在任务模型中添加 `task_type` 字段（`single`/`workflow`）
- 虽然可以通过 `workflow_id` 判断，但显式字段更清晰

#### 1.2 配置验证增强
- **单个接口任务**：必须配置 `config_id`，不能配置 `workflow_id`
- **流程配置任务**：必须配置 `workflow_id`，`config_id` 可选（用于兼容）

#### 1.3 参数配置细化
- **单个接口任务**：`task_params` 直接覆盖接口参数
- **流程配置任务**：`task_params` 作为全局参数，可被步骤参数覆盖

### 2. 调度管理细化

#### 2.1 任务列表展示
- 区分显示任务类型（单个接口/流程配置）
- 显示任务关联的接口/流程信息
- 显示步骤数量（流程配置任务）

#### 2.2 执行监控
- **单个接口任务**：
  - 显示接口名称
  - 显示最后执行结果
  - 显示数据记录数
- **流程配置任务**：
  - 显示流程名称
  - 显示步骤列表和执行状态
  - 显示各步骤的数据记录数
  - 显示步骤执行时长

#### 2.3 日志查询优化
- 支持按任务类型筛选
- 流程配置任务支持查看步骤级日志
- 支持查看任务整体执行情况

### 3. 数据存储细化

#### 3.1 表名配置
- **单个接口任务**：使用 `data_table_name` 或默认表名
- **流程配置任务**：支持为每个步骤配置不同的表名（通过步骤配置）

#### 3.2 数据查询
- 支持按任务类型查询数据
- 流程配置任务支持按步骤筛选数据

### 4. 错误处理细化

#### 4.1 单个接口任务
- 失败则整个任务失败
- 记录详细错误信息

#### 4.2 流程配置任务
- 单个步骤失败不影响其他步骤
- 记录每个步骤的错误信息
- 提供任务整体执行状态（全部成功/部分成功/全部失败）

## 三、实现建议

### 1. 数据库字段扩展
- 添加 `task_type` 字段（可选，可通过 `workflow_id` 判断）
- 在任务查询中自动识别任务类型

### 2. 服务层增强
- 在任务详情中返回任务类型
- 流程配置任务返回步骤列表和执行状态
- 提供任务执行统计信息（区分单个接口和流程配置）

### 3. 调度器增强
- 在调度器注册时记录任务类型
- 提供任务类型相关的监控接口

### 4. 前端展示优化
- 任务列表区分显示任务类型
- 流程配置任务显示步骤信息
- 日志查询支持按任务类型筛选
